<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Postgres Operator | Diglog</title><meta name=keywords content="Postgres,Operator"><meta name=description content="오픈소스 Postgres Operator 소개글"><meta name=author content="Hyeongbin Kim"><link rel=canonical href=https://diglog.io/posts/postgres-operator/><meta name=google-site-verification content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.min.04512c372388e08b5118f5b117b2d3efef4ddae52017e16085c8d8d4e361c43d.css integrity="sha256-BFEsNyOI4ItRGPWxF7LT7+9N2uUgF+FghcjY1ONhxD0=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.2840b7fccd34145847db71a290569594bdbdb00047097f75d6495d162f5d7dff.js integrity="sha256-KEC3/M00FFhH23GikFaVlL29sABHCX911kldFi9dff8=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://diglog.io/favicon.png><link rel=icon type=image/png sizes=16x16 href=https://diglog.io/favicon.png><link rel=icon type=image/png sizes=32x32 href=https://diglog.io/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://diglog.io/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://diglog.io/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.98.0"><script async src="https://www.googletagmanager.com/gtag/js?id=G-ZBCBJN6NV1"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-ZBCBJN6NV1",{anonymize_ip:!1})}</script><meta property="og:title" content="Postgres Operator"><meta property="og:description" content="오픈소스 Postgres Operator 소개글"><meta property="og:type" content="article"><meta property="og:url" content="https://diglog.io/posts/postgres-operator/"><meta property="og:image" content="https://diglog.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-04-20T10:51:09+09:00"><meta property="article:modified_time" content="2022-04-20T10:51:09+09:00"><meta property="og:site_name" content="Diglog"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://diglog.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="Postgres Operator"><meta name=twitter:description content="오픈소스 Postgres Operator 소개글"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://diglog.io/posts/"},{"@type":"ListItem","position":3,"name":"Postgres Operator","item":"https://diglog.io/posts/postgres-operator/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Postgres Operator","name":"Postgres Operator","description":"오픈소스 Postgres Operator 소개글","keywords":["Postgres","Operator"],"articleBody":"Postgres 데이터베이스를 K8s 환경에서 배포하는 방법을 찾고 있다면 오픈소스로 공개된 Postgres Operator들을 고려해 볼 수 있다. Postgres 컨테이너 이미지를 기반으로 직접 배포해볼 수도 있지만, 오퍼레이터를 통해 여러 K8s 자원들의 배포 및 관리 자동화하여 operational cost를 줄일 수 있다. Zalando나 Crunchy Data사에서 제공하는 오퍼레이터는 failover 말고 라도 Connection Pool, 백업, 모니터링 등 다른 기능셋들도 제공하기 때문에 다른 Postgres Operator 비교 블로그 글에서도 추천의 대상으로 많이 꼽고 있다. 이번 블로그에서는 이 둘 오퍼레이터에 대해서 알아보고자 한다.\n들어가며 두 오퍼레이터의 차이점을 나눠서 알아보기 전에 앞서 알아두면 좋을 사전지식을 정리해두고자 한다. 먼저, 공통점을 살펴보자. 오퍼레이터가 관리하는 K8s 자원들이다. 크게 6개로 나눌수 있는데, Postgres 컨테이너 이미지로 Primary와 Standby Pod으로 배포되는 Statefulset, Connection Pool을 배포하기 위한 Deployment, Client가 DB에 접근 가능하도록 필요한 Service, Postgresql configuration 설정 정보 관리를 위한 ConfigMap과 접근 정보 관리를 위한 Secret, 마지막으로 Transaction log 등 데이터베이스 state를 관리하기 하기 위한 각종 정보를 저장하는 PVC와 PV가 존재한다.\nPostgres 컨테이너 이미지로는 물론 공식 이미지가 존재하지만, 요건에 따라 필요 기능들을 추가하여 재 패키징한 프로젝트들도 많다. Postgres HA 프레임워크 중 하나인 Patroni 프로젝트를 컨테이너화한 Spilo가 대표적이며, EnterpriseDB사에서는 PgBouncer를 패키징한 docker-pgbouncer와 Backup 기능을 위한 자체 솔루션 + PostGIS + PGAudit를 포함해 패키징한 docker-postgresql도 제공한다. Bitnami에서는 또 다른 Postgres HA 프레임워크인 repmgr를 포함해 패키징한 프로젝트인 bitnami-docker-postgresql-repmgr가 있다.\nFailover 다음으로 Postgres의 주요 기능들에 대해서 살펴보고자 한다. 첫번째로 Postgres HA 프레임워크이다. 우선 Postgres는 기본적으로 primary와 standby 사이에 WAL(Write Ahead Log) 기반으로 streaming replication을 지원한다. 하지만, 클러스터링 기능은 제공하지 않기 때문에 primary, standby 인스턴스 관리를 위한 솔루션이 필요하다. K8s 환경에서 DBaaS를 제공한다고 해도 node fail의 상황이나 primary pod 혹은 standby pod이 죽을 경우, (다른 node에) 새 pod이 생성되는 container orchestration은 되지만, DB를 정상적으로 사용할 수 있기 위해서 standby = primary로 바꾸는 promotion, primary = standby로 교체하는 demotion과 같은 custom logic을 직접 개발하거나 이미 개발된 Postgres HA framework 사용이 필수적이다.\n주로 사용되는 Postgres HA 솔루션으로는 Patroni, PAF(pacemaker + corosync), repmgr가 있다. 해당 블로그에서는 각각의 failover 시나리오에 대해서 테스트 결과가 잘 정리되어 있다. Zalando사와 Crunchy Data사에서 Patroni를 사용하고 있는 만큼 Patroni에 대해서는 밑에서 좀 더 자세히 알아보려고 한다.\nConnection pool 두번째로 Connection Pool 기능이다. Connection Pool은 Postgres client와 Postgres 서버 사이의 connection을 관리하여 connection을 재사용하고, 실제 사용하지 않는 Idle 상태 Connection 회수하여 Postgres 서버 오버헤드를 줄이기 위한 목적으로 사용하는 기능이다. 자주 언급되는 솔루션으로는 PgBouncer와 Pgpool-II이 있는데, Zalando사와 Crunchy Data사에서는 PgBouncer를 사용하고 있다. 그 둘의 대한 비교는 해당 블로그에서 자세하게 다루고 있다. LB 기능 지원이 Pgpool-II의 가장 큰 장점이지만, connection 큐잉과 다양한 pool 모드 지원 등 connection 자체에 대한 관리는 PgBouncer가 더 뛰어나다고 볼 수 있다. Pgpool-II이 지원하는 LB 기능은 읽기 요청인지 쓰기 요청인지 여부에 따라서 primary와 standby에 분산해서 처리할 수 있으며, 기본 PgBouncer에 위와 같은 LB 기능과 쿼리 rewrite 기능까지 추가한 프로젝트가 궁금하다면 awslabs의 pgbouncer-rr-patch를 참고하기 바란다.\nZalando Zalando Postgres Operator는 유럽 대형 쇼핑몰 회사인 Zalando에서 만들어서 사내에서 실 사용중인 것으로 알려진 오픈소스 오퍼레이터이다. Python 구현체인 Patroni를 컨테이너화한 Spilio 컨테이너 이미지를 사용하여 Postgres CR을 배포하고 Statefulset 등 여러 관련 k8s 리소스를 관리한다.\nZalando의 경우에는 kubebuilder나 controller-runtime을 사용하지 않고 client-go 등을 직접 사용해서 오퍼레이터를 개발했다. Patroni REST API를 호출하여 switchover가 이뤄지는데, node 상태에 따라서 patroni api를 호출하는 flow를 가진다.\n/cmd/main.go 부터 코드를 타고 가면,\nmain.go = controller.go run() = controller.go initController() = controller.go initSharedInformers() = node.go 에 이르게 된다.\nc.nodesInformer.AddEventHandler(cache.ResourceEventHandlerFuncs{ \tAddFunc: c.nodeAdd, \tUpdateFunc: c.nodeUpdate, \tDeleteFunc: c.nodeDelete, }) func (c *Controller) nodeAdd(obj interface{}) { \tnode, ok := obj.(*v1.Node) \tif !ok { \treturn \t}  \tc.logger.Debugf(\"new node has been added: %s (%s)\", util.NameFromMeta(node.ObjectMeta), node.Spec.ProviderID)  \t// check if the node became not ready while the operator was down (otherwise we would have caught it in nodeUpdate) \tif !c.nodeIsReady(node) { \tc.moveMasterPodsOffNode(node) \t} } node가 ready 상태가 아니라면 master pod(primary)를 옮기는데,\nnode.go moveMasterPodsOffNode() = node.go attemptToMoveMasterPodsOffNode() = pod.go MigrateMasterPod() = cluster.go Switchover() = patroni.go Switchover() 가 종착점이다.\nSwitchover는 현재 primary pod을 다른 candidate pod로 바꾸는 API이다.\n// Switchover by calling Patroni REST API func (p *Patroni) Switchover(master *v1.Pod, candidate string) error { \tbuf := \u0026bytes.Buffer{} \terr := json.NewEncoder(buf).Encode(map[string]string{\"leader\": master.Name, \"member\": candidate}) \tif err != nil { \treturn fmt.Errorf(\"could not encode json: %v\", err) \t} \tapiURLString, err := apiURL(master) \tif err != nil { \treturn err \t} \treturn p.httpPostOrPatch(http.MethodPost, apiURLString+failoverPath, buf) } Switchover와 달리 특정 pod 재기동이 필요한 상황에는 patroni.go에 정의된 Restart() 인터페이스에 따라 pod 재시작 시키는 patroni restart REST API를 호출하고 있다.\nEvent 종류가 Update 인지, Sync 인지에 따라서 호출 flow 중 조금의 차이가 있다.\n  main.go = controller.go run() = postgresql.go processClusterEventsQueue() = postgresql.go processEvent() = sync.go Sync() = sync.go syncStatefulSet() = sync.go restartInstance() = patroni.go Restart()\n  main.go = controller.go run() = postgresql.go processClusterEventsQueue() = postgresql.go processEvent() = cluster.go Update() = sync.go syncStatefulSet() = sync.go restartInstance() = patroni.go Restart()\n  모니터링 기능을 보면, Zalando의 경우에는 사내에서 모니터링을 위한 다른 솔루션을 사용하고 있기 때문에 Prometheus 연동을 위한 exporter pod 이나 별도의 배포 yaml을 제공하지 않는다. Repo 내에 issue에서 모니터링 관련 example yaml이 공유되고 operator에 대한 모니터링을 위한 pr이 있지만 기본적으로 Prometheus 연동를 위한 role, service 등 K8s 리소스와 PrometheusRule를 함께 고려하여 prometheus-postgres-exporter를 zalando-operator의 sidecar container로 배포해야한다.\nCrunchy Data Crunchy Data는 Postgres DB 관련 상용 솔루션 만드는 it 회사이다. Postgres Operator는 오픈소스 프로젝트이지만, 이를 유지보수하고 구축하는 공수는 상용 서비스로 제공하고 있어서 실 사용시에 Crunchy Data 오퍼레이터를 우선적으로 고려하기도 한다.\nCrunchy Data는 controller runtime을 기반으로 개발되어 kubebuilder나 operator-sdk 사용경험이 있다면 좀 더 쉽게 소스코드를 navigate 할 수 있다. Failover 기능을 implement한 방법 부터 알아보자면, Zalando 처럼 SwitchOver가 필요한 상황을 감지하여 자동 실행되는 로직은 아니다. Crunchy Data의 경우에는 해당 PR을 기반으로 SwitchOver가 필요한 경우에 Postgres CR spec 변경을 직접 해줘야 SwitchOver가 트리거 된다.\npkg/apis/postgres-operator.crunchydata.com/v1beta1/patroni_types.go에 아래와 같이 const가 설정 되어 있고, PatroniSwitchover.Type이 존재하지만\nPatroniSwitchoverTypeFailover = \"Failover\" PatroniSwitchoverTypeSwitchover = \"Switchover\" crunchy data 코드 내부에서는 PatroniSwitchover.Type을 셋팅해주는 부분이 없다. 하지만 해당 값이 설정 된 경우에는 patronictl cmd를 실행하여 switchover, 그리고 primary pod이 존재 하지 않는 경우나 candidate pod을 특정할 수 없는 경우에 failover가 실행된다.\nFailover 실행 플로우를 보면 아래와 같다.\ninternal/controller/postgrescluster/controller.go\n Reconcile() - instance.go reconcileInstanceSets() - rolloutInstance() - api.go ChangePrimaryAndWait() Reconcile() - patroni.go reconcilePatroniSwitchover() - api.go SwitchoverAndWait() or FailoverAndWait()  internal/controller/postgrescluster/patroni.go의 reconcilePatroniSwitchover() 함수를 참고하면,\nif cluster.Spec.Patroni == nil || cluster.Spec.Patroni.Switchover == nil || \t!cluster.Spec.Patroni.Switchover.Enabled { \tcluster.Status.Patroni.Switchover = nil \treturn nil } Patroni 개체의 Switchover.Type 값에 따라서, SwitchoverAndWait() 혹은 FailoverAndWait()를 실행한다. SwitchoverAndWait()의 경우에는 ChangePrimaryAndWait()와 달리 primary pod와 이를 대신 할 candidate pod을 인자로 받으며, FailoverAndWait()은 primary pod이 존재하지 않는 경우로 candidate pod만 인자로 받는다.\nrolloutInstances()의 경우에는 pod 재배포가 필요한 경우 재배포 하면서, 해당 pod이 primary인 경우에 primary를 교체하는 ChangePrimaryAndWait() 함수를 호출한다. 이 경우에는 patroni가 현재 상태에서 가장 best candidate을 직접 선택하고 primary를 demote 시킨다.\nif primary \u0026\u0026 len(instances.forCluster)  1 { \tvar span trace.Span \tctx, span = r.Tracer.Start(ctx, \"patroni-change-primary\") \tdefer span.End()  \tsuccess, err := patroni.Executor(exec).ChangePrimaryAndWait(ctx, pod.Name, \"\") 모니터링 관련해서는 pgmonitor 라는 별도의 프로젝트가 존재한다. postgres 버전 별로 DB metric을 가져오기 위한 환경 설정 값들이 정의 되어 있으며, pgnodemx PostgreSQL extension을 사용하여 node의 OS 관련 metric을 sql 쿼리로 가져올 수 있다. CrunchyData Operator를 사용하면 cluster CR에 monitoring 사용 명시할 수 있는데, enable 된 경우 metric 수집 접근이 가능 하도록 pg_hba.conf 파일 설정 업데이트 및 기타 환경 설정과 필요한 SQL 쿼리를 실행해주기 때문에 편리하다. postgres exporter container는 따로 배포하지 않아도 되고, 모니터링 시스템만 배포해주면 된다. prometheus, grafana, alertmanager를 배포하는 yaml을 모아둔 샘플 프로젝트를 제공하기 때문에 해당 가이드를 참고하여 간단하게 배포 가능하다.\n$ kubectl apply -k kustomize/monitoring 마무리 결론적으로 fail over 자동화를 본다면 zalando가 모니터링 자동화 기능을 우선시 한다면 crunchy data operator를 사용을 고려해볼 수 있다. 하지만 둘 중 어떤 PostgreSQL 오픈소스 오퍼레이터를 선택하더라도 실 사용시 기능 추가가 필요할 가능성이 높다. Zalando operator를 fork해서 개발한 사례를 참고해보고 실제 공수를 잘 따져서 새로운 PostgreSQL 오퍼레이터를 개발하는 선택지도 고려해보자.\nReference  Comparing Kubernetes operators for PostgreSQL  CrunchyData Vs Zalando 참고 자료  https://github.com/CrunchyData/postgres-operator/issues/992 https://www.reddit.com/r/kubernetes/comments/fjm3vd/comparison_of_choices_to_run_dbspostgresql_crd_on/ https://news.ycombinator.com/item?id=28758162  ","wordCount":"1218","inLanguage":"en","datePublished":"2022-04-20T10:51:09+09:00","dateModified":"2022-04-20T10:51:09+09:00","author":{"@type":"Person","name":"Hyeongbin Kim"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://diglog.io/posts/postgres-operator/"},"publisher":{"@type":"Organization","name":"Diglog","logo":{"@type":"ImageObject","url":"https://diglog.io/favicon.png"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><noscript><style type=text/css>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:#1d1e20;--entry:#2e2e33;--primary:rgba(255, 255, 255, 0.84);--secondary:rgba(255, 255, 255, 0.56);--tertiary:rgba(255, 255, 255, 0.16);--content:rgba(255, 255, 255, 0.74);--hljs-bg:#2e2e33;--code-bg:#37383e;--border:#333}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><header class=header><nav class=nav><div class=logo><a href=https://diglog.io accesskey=h title="Home (Alt + H)">Home</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu onscroll=menu_on_scroll()><li><a href=https://diglog.io/archives/ title=Archive><span>Archive</span></a></li><li><a href=https://diglog.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://diglog.io/tags/ title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Postgres Operator</h1><div class=post-description>오픈소스 Postgres Operator 소개글</div><div class=post-meta>April 20, 2022&nbsp;·&nbsp;6 min&nbsp;·&nbsp;Hyeongbin Kim</div></header><div class=post-content><p>Postgres 데이터베이스를 K8s 환경에서 배포하는 방법을 찾고 있다면 오픈소스로 공개된 Postgres Operator들을 고려해 볼 수 있다. Postgres 컨테이너 이미지를 기반으로 직접 배포해볼 수도 있지만, 오퍼레이터를 통해 여러 K8s 자원들의 배포 및 관리 자동화하여 operational cost를 줄일 수 있다. Zalando나 Crunchy Data사에서 제공하는 오퍼레이터는 failover 말고 라도 Connection Pool, 백업, 모니터링 등 다른 기능셋들도 제공하기 때문에 다른 Postgres Operator 비교 블로그 글에서도 추천의 대상으로 많이 꼽고 있다. 이번 블로그에서는 이 둘 오퍼레이터에 대해서 알아보고자 한다.</p><h2 id=들어가며>들어가며<a hidden class=anchor aria-hidden=true href=#들어가며>#</a></h2><p>두 오퍼레이터의 차이점을 나눠서 알아보기 전에 앞서 알아두면 좋을 사전지식을 정리해두고자 한다. 먼저, 공통점을 살펴보자. 오퍼레이터가 관리하는 K8s 자원들이다. 크게 6개로 나눌수 있는데, Postgres 컨테이너 이미지로 Primary와 Standby Pod으로 배포되는 <code>Statefulset</code>, Connection Pool을 배포하기 위한 <code>Deployment</code>, Client가 DB에 접근 가능하도록 필요한 <code>Service</code>, Postgresql configuration 설정 정보 관리를 위한 <code>ConfigMap</code>과 접근 정보 관리를 위한 <code>Secret</code>, 마지막으로 Transaction log 등 데이터베이스 state를 관리하기 하기 위한 각종 정보를 저장하는 <code>PVC</code>와 <code>PV</code>가 존재한다.</p><p>Postgres 컨테이너 이미지로는 물론 <a href=https://hub.docker.com/_/postgres>공식 이미지</a>가 존재하지만, 요건에 따라 필요 기능들을 추가하여 재 패키징한 프로젝트들도 많다. Postgres HA 프레임워크 중 하나인 <a href=https://github.com/zalando/patroni>Patroni</a> 프로젝트를 컨테이너화한 <a href=https://github.com/zalando/spilo>Spilo</a>가 대표적이며, EnterpriseDB사에서는 PgBouncer를 패키징한 <a href=https://github.com/EnterpriseDB/docker-pgbouncer>docker-pgbouncer</a>와 Backup 기능을 위한 자체 솔루션 + PostGIS + PGAudit를 포함해 패키징한 <a href=https://github.com/EnterpriseDB/docker-postgresql>docker-postgresql</a>도 제공한다. Bitnami에서는 또 다른 Postgres HA 프레임워크인 repmgr를 포함해 패키징한 프로젝트인 <a href=https://github.com/bitnami/bitnami-docker-postgresql-repmgr>bitnami-docker-postgresql-repmgr</a>가 있다.</p><h3 id=failover>Failover<a hidden class=anchor aria-hidden=true href=#failover>#</a></h3><p>다음으로 Postgres의 주요 기능들에 대해서 살펴보고자 한다. 첫번째로 Postgres HA 프레임워크이다. 우선 Postgres는 기본적으로 primary와 standby 사이에 WAL(Write Ahead Log) 기반으로 <a href=https://wiki.postgresql.org/wiki/Streaming_Replication>streaming replication</a>을 지원한다. 하지만, 클러스터링 기능은 제공하지 않기 때문에 primary, standby 인스턴스 관리를 위한 솔루션이 필요하다. K8s 환경에서 DBaaS를 제공한다고 해도 node fail의 상황이나 primary pod 혹은 standby pod이 죽을 경우, (다른 node에) 새 pod이 생성되는 container orchestration은 되지만, DB를 정상적으로 사용할 수 있기 위해서 standby => primary로 바꾸는 <code>promotion</code>, primary => standby로 교체하는 <code>demotion</code>과 같은 custom logic을 직접 개발하거나 이미 개발된 Postgres HA framework 사용이 필수적이다.</p><p>주로 사용되는 Postgres HA 솔루션으로는 Patroni, PAF(pacemaker + corosync), repmgr가 있다. <a href=https://scalegrid.io/blog/whats-the-best-postgresql-high-availability-framework-paf-vs-repmgr-vs-patroni-infographic/>해당 블로그</a>에서는 각각의 failover 시나리오에 대해서 테스트 결과가 잘 정리되어 있다. Zalando사와 Crunchy Data사에서 Patroni를 사용하고 있는 만큼 Patroni에 대해서는 밑에서 좀 더 자세히 알아보려고 한다.</p><h3 id=connection-pool>Connection pool<a hidden class=anchor aria-hidden=true href=#connection-pool>#</a></h3><p>두번째로 Connection Pool 기능이다. Connection Pool은 Postgres client와 Postgres 서버 사이의 connection을 관리하여 connection을 재사용하고, 실제 사용하지 않는 Idle 상태 Connection 회수하여 Postgres 서버 오버헤드를 줄이기 위한 목적으로 사용하는 기능이다. 자주 언급되는 솔루션으로는 <a href=https://www.pgbouncer.org/>PgBouncer</a>와 <a href=https://www.pgpool.net/docs/latest/en/html/intro-whatis.html>Pgpool-II</a>이 있는데, Zalando사와 Crunchy Data사에서는 PgBouncer를 사용하고 있다. 그 둘의 대한 비교는 <a href="https://scalegrid.io/blog/postgresql-connection-pooling-part-4-pgbouncer-vs-pgpool/#:~:text=PgBouncer%20allows%20limiting%20connections%20per,overall%20number%20of%20connections%20only.&text=PgBouncer%20supports%20queuing%20at%20the,i.e.%20PgBouncer%20maintains%20the%20queue">해당 블로그</a>에서 자세하게 다루고 있다. LB 기능 지원이 Pgpool-II의 가장 큰 장점이지만, connection 큐잉과 다양한 pool 모드 지원 등 connection 자체에 대한 관리는 PgBouncer가 더 뛰어나다고 볼 수 있다. Pgpool-II이 지원하는 LB 기능은 읽기 요청인지 쓰기 요청인지 여부에 따라서 primary와 standby에 분산해서 처리할 수 있으며, 기본 PgBouncer에 위와 같은 LB 기능과 쿼리 rewrite 기능까지 추가한 프로젝트가 궁금하다면 awslabs의 <a href=https://github.com/awslabs/pgbouncer-rr-patch>pgbouncer-rr-patch</a>를 참고하기 바란다.</p><h2 id=zalando>Zalando<a hidden class=anchor aria-hidden=true href=#zalando>#</a></h2><p>Zalando Postgres Operator는 유럽 대형 쇼핑몰 회사인 Zalando에서 만들어서 사내에서 실 사용중인 것으로 알려진 오픈소스 오퍼레이터이다. Python 구현체인 Patroni를 컨테이너화한 Spilio 컨테이너 이미지를 사용하여 Postgres CR을 배포하고 Statefulset 등 여러 관련 k8s 리소스를 관리한다.</p><p>Zalando의 경우에는 kubebuilder나 controller-runtime을 사용하지 않고 client-go 등을 직접 사용해서 오퍼레이터를 개발했다. Patroni REST API를 호출하여 switchover가 이뤄지는데, node 상태에 따라서 patroni api를 호출하는 flow를 가진다.</p><p><code>/cmd/main.go</code> 부터 코드를 타고 가면,</p><p><code>main.go</code> => <code>controller.go</code> run() => <code>controller.go</code> initController() => <code>controller.go</code> initSharedInformers() => <code>node.go</code> 에 이르게 된다.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>nodesInformer</span>.<span style=color:#a6e22e>AddEventHandler</span>(<span style=color:#a6e22e>cache</span>.<span style=color:#a6e22e>ResourceEventHandlerFuncs</span>{
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>AddFunc</span>:    <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>nodeAdd</span>,
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>UpdateFunc</span>: <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>nodeUpdate</span>,
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>DeleteFunc</span>: <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>nodeDelete</span>,
</span></span><span style=display:flex><span>})
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Controller</span>) <span style=color:#a6e22e>nodeAdd</span>(<span style=color:#a6e22e>obj</span> <span style=color:#66d9ef>interface</span>{}) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>node</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>obj</span>.(<span style=color:#f92672>*</span><span style=color:#a6e22e>v1</span>.<span style=color:#a6e22e>Node</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>Debugf</span>(<span style=color:#e6db74>&#34;new node has been added: %s (%s)&#34;</span>, <span style=color:#a6e22e>util</span>.<span style=color:#a6e22e>NameFromMeta</span>(<span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>ObjectMeta</span>), <span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>Spec</span>.<span style=color:#a6e22e>ProviderID</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// check if the node became not ready while the operator was down (otherwise we would have caught it in nodeUpdate)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>nodeIsReady</span>(<span style=color:#a6e22e>node</span>) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>moveMasterPodsOffNode</span>(<span style=color:#a6e22e>node</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>node가 ready 상태가 아니라면 master pod(primary)를 옮기는데,</p><p><code>node.go</code> moveMasterPodsOffNode() => <code>node.go</code> attemptToMoveMasterPodsOffNode() => <code>pod.go</code> MigrateMasterPod() => <code>cluster.go</code> Switchover() => <code>patroni.go</code> Switchover() 가 종착점이다.</p><p>Switchover는 현재 primary pod을 다른 candidate pod로 바꾸는 API이다.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// Switchover by calling Patroni REST API
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>p</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Patroni</span>) <span style=color:#a6e22e>Switchover</span>(<span style=color:#a6e22e>master</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>v1</span>.<span style=color:#a6e22e>Pod</span>, <span style=color:#a6e22e>candidate</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>buf</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>bytes</span>.<span style=color:#a6e22e>Buffer</span>{}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>NewEncoder</span>(<span style=color:#a6e22e>buf</span>).<span style=color:#a6e22e>Encode</span>(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span>{<span style=color:#e6db74>&#34;leader&#34;</span>: <span style=color:#a6e22e>master</span>.<span style=color:#a6e22e>Name</span>, <span style=color:#e6db74>&#34;member&#34;</span>: <span style=color:#a6e22e>candidate</span>})
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;could not encode json: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>apiURLString</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>apiURL</span>(<span style=color:#a6e22e>master</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>httpPostOrPatch</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>MethodPost</span>, <span style=color:#a6e22e>apiURLString</span><span style=color:#f92672>+</span><span style=color:#a6e22e>failoverPath</span>, <span style=color:#a6e22e>buf</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Switchover와 달리 특정 pod 재기동이 필요한 상황에는 <code>patroni.go</code>에 정의된 Restart() 인터페이스에 따라 pod 재시작 시키는 patroni restart REST API를 호출하고 있다.</p><p>Event 종류가 Update 인지, Sync 인지에 따라서 호출 flow 중 조금의 차이가 있다.</p><ul><li><p><code>main.go</code> => <code>controller.go</code> run() => <code>postgresql.go</code> processClusterEventsQueue() => <code>postgresql.go</code> processEvent() => <code>sync.go</code> Sync() => <code>sync.go</code> syncStatefulSet() => <code>sync.go</code> restartInstance() => <code>patroni.go</code> Restart()</p></li><li><p><code>main.go</code> => <code>controller.go</code> run() => <code>postgresql.go</code> processClusterEventsQueue() => <code>postgresql.go</code> processEvent() => <code>cluster.go</code> Update() => <code>sync.go</code> syncStatefulSet() => <code>sync.go</code> restartInstance() => <code>patroni.go</code> Restart()</p></li></ul><p>모니터링 기능을 보면, Zalando의 경우에는 사내에서 모니터링을 위한 다른 솔루션을 사용하고 있기 때문에 Prometheus 연동을 위한 exporter pod 이나 별도의 배포 yaml을 제공하지 않는다. Repo 내에 <a href=https://github.com/zalando/postgres-operator/issues/264>issue</a>에서 모니터링 관련 example yaml이 공유되고 operator에 대한 모니터링을 위한 <a href=https://github.com/zalando/postgres-operator/pull/1529>pr</a>이 있지만 기본적으로 Prometheus 연동를 위한 role, service 등 K8s 리소스와 PrometheusRule를 함께 고려하여 <a href=https://github.com/prometheus-community/helm-charts/tree/main/charts/prometheus-postgres-exporter>prometheus-postgres-exporter</a>를 zalando-operator의 sidecar container로 배포해야한다.</p><h2 id=crunchy-data>Crunchy Data<a hidden class=anchor aria-hidden=true href=#crunchy-data>#</a></h2><p>Crunchy Data는 Postgres DB 관련 상용 솔루션 만드는 it 회사이다. Postgres Operator는 오픈소스 프로젝트이지만, 이를 유지보수하고 구축하는 공수는 상용 서비스로 제공하고 있어서 실 사용시에 Crunchy Data 오퍼레이터를 우선적으로 고려하기도 한다.</p><p>Crunchy Data는 controller runtime을 기반으로 개발되어 kubebuilder나 operator-sdk 사용경험이 있다면 좀 더 쉽게 소스코드를 navigate 할 수 있다. Failover 기능을 implement한 방법 부터 알아보자면, Zalando 처럼 SwitchOver가 필요한 상황을 감지하여 자동 실행되는 로직은 아니다. Crunchy Data의 경우에는 <a href=https://github.com/CrunchyData/postgres-operator/pull/2794>해당 PR</a>을 기반으로 SwitchOver가 필요한 경우에 Postgres CR spec 변경을 직접 해줘야 SwitchOver가 트리거 된다.</p><p><code>pkg/apis/postgres-operator.crunchydata.com/v1beta1/patroni_types.go</code>에 아래와 같이 const가 설정 되어 있고, PatroniSwitchover.Type이 존재하지만</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>PatroniSwitchoverTypeFailover</span>   = <span style=color:#e6db74>&#34;Failover&#34;</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>PatroniSwitchoverTypeSwitchover</span> = <span style=color:#e6db74>&#34;Switchover&#34;</span>
</span></span></code></pre></div><p>crunchy data 코드 내부에서는 PatroniSwitchover.Type을 셋팅해주는 부분이 없다. 하지만 해당 값이 설정 된 경우에는 patronictl cmd를 실행하여 switchover, 그리고 primary pod이 존재 하지 않는 경우나 candidate pod을 특정할 수 없는 경우에 failover가 실행된다.</p><p>Failover 실행 플로우를 보면 아래와 같다.</p><p><code>internal/controller/postgrescluster/controller.go</code></p><ul><li>Reconcile() -> <code>instance.go</code> reconcileInstanceSets() -> rolloutInstance() -> <code>api.go</code> ChangePrimaryAndWait()</li><li>Reconcile() -> <code>patroni.go</code> reconcilePatroniSwitchover() -> <code>api.go</code> SwitchoverAndWait() or FailoverAndWait()</li></ul><p><code>internal/controller/postgrescluster/patroni.go</code>의 reconcilePatroniSwitchover() 함수를 참고하면,</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>cluster</span>.<span style=color:#a6e22e>Spec</span>.<span style=color:#a6e22e>Patroni</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>cluster</span>.<span style=color:#a6e22e>Spec</span>.<span style=color:#a6e22e>Patroni</span>.<span style=color:#a6e22e>Switchover</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> <span style=color:#f92672>||</span>
</span></span><span style=display:flex><span>	!<span style=color:#a6e22e>cluster</span>.<span style=color:#a6e22e>Spec</span>.<span style=color:#a6e22e>Patroni</span>.<span style=color:#a6e22e>Switchover</span>.<span style=color:#a6e22e>Enabled</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>cluster</span>.<span style=color:#a6e22e>Status</span>.<span style=color:#a6e22e>Patroni</span>.<span style=color:#a6e22e>Switchover</span> = <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Patroni 개체의 Switchover.Type 값에 따라서, SwitchoverAndWait() 혹은 FailoverAndWait()를 실행한다. SwitchoverAndWait()의 경우에는 ChangePrimaryAndWait()와 달리 primary pod와 이를 대신 할 candidate pod을 인자로 받으며, FailoverAndWait()은 primary pod이 존재하지 않는 경우로 candidate pod만 인자로 받는다.</p><p><code>rolloutInstances()</code>의 경우에는 pod 재배포가 필요한 경우 재배포 하면서, 해당 pod이 primary인 경우에 primary를 교체하는 <code>ChangePrimaryAndWait()</code> 함수를 호출한다. 이 경우에는 patroni가 현재 상태에서 가장 best candidate을 직접 선택하고 primary를 demote 시킨다.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>primary</span> <span style=color:#f92672>&amp;&amp;</span> len(<span style=color:#a6e22e>instances</span>.<span style=color:#a6e22e>forCluster</span>) &gt; <span style=color:#ae81ff>1</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>span</span> <span style=color:#a6e22e>trace</span>.<span style=color:#a6e22e>Span</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>span</span> = <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Tracer</span>.<span style=color:#a6e22e>Start</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#e6db74>&#34;patroni-change-primary&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>span</span>.<span style=color:#a6e22e>End</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>success</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>patroni</span>.<span style=color:#a6e22e>Executor</span>(<span style=color:#a6e22e>exec</span>).<span style=color:#a6e22e>ChangePrimaryAndWait</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>pod</span>.<span style=color:#a6e22e>Name</span>, <span style=color:#e6db74>&#34;&#34;</span>)
</span></span></code></pre></div><p>모니터링 관련해서는 <a href=https://github.com/CrunchyData/pgmonitor>pgmonitor</a> 라는 별도의 프로젝트가 존재한다. postgres 버전 별로 DB metric을 가져오기 위한 환경 설정 값들이 정의 되어 있으며, <a href=https://github.com/CrunchyData/pgnodemx>pgnodemx</a> PostgreSQL extension을 사용하여 node의 OS 관련 metric을 sql 쿼리로 가져올 수 있다. CrunchyData Operator를 사용하면 cluster CR에 monitoring 사용 명시할 수 있는데, enable 된 경우 metric 수집 접근이 가능 하도록 pg_hba.conf 파일 설정 업데이트 및 기타 환경 설정과 필요한 SQL 쿼리를 실행해주기 때문에 편리하다. postgres exporter container는 따로 배포하지 않아도 되고, 모니터링 시스템만 배포해주면 된다. prometheus, grafana, alertmanager를 배포하는 yaml을 모아둔 <a href=https://github.com/CrunchyData/postgres-operator-examples>샘플 프로젝트</a>를 제공하기 때문에 <a href=https://access.crunchydata.com/documentation/postgres-operator/5.1.0/installation/monitoring/kustomize/>해당 가이드</a>를 참고하여 간단하게 배포 가능하다.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ kubectl apply -k kustomize/monitoring
</span></span></code></pre></div><h2 id=마무리>마무리<a hidden class=anchor aria-hidden=true href=#마무리>#</a></h2><p>결론적으로 fail over 자동화를 본다면 zalando가 모니터링 자동화 기능을 우선시 한다면 crunchy data operator를 사용을 고려해볼 수 있다. 하지만 둘 중 어떤 PostgreSQL 오픈소스 오퍼레이터를 선택하더라도 실 사용시 기능 추가가 필요할 가능성이 높다. <a href=https://blog.flant.com/our-experience-with-postgres-operator-for-kubernetes-by-zalando/>Zalando operator를 fork해서 개발한 사례</a>를 참고해보고 실제 공수를 잘 따져서 새로운 PostgreSQL 오퍼레이터를 개발하는 선택지도 고려해보자.</p><h3 id=reference>Reference<a hidden class=anchor aria-hidden=true href=#reference>#</a></h3><ul><li><a href=https://blog.flant.com/comparing-kubernetes-operators-for-postgresql/>Comparing Kubernetes operators for PostgreSQL</a></li></ul><h3 id=crunchydata-vs-zalando-참고-자료>CrunchyData Vs Zalando 참고 자료<a hidden class=anchor aria-hidden=true href=#crunchydata-vs-zalando-참고-자료>#</a></h3><ul><li><a href=https://github.com/CrunchyData/postgres-operator/issues/992>https://github.com/CrunchyData/postgres-operator/issues/992</a></li><li><a href=https://www.reddit.com/r/kubernetes/comments/fjm3vd/comparison_of_choices_to_run_dbspostgresql_crd_on/>https://www.reddit.com/r/kubernetes/comments/fjm3vd/comparison_of_choices_to_run_dbspostgresql_crd_on/</a></li><li><a href="https://news.ycombinator.com/item?id=28758162">https://news.ycombinator.com/item?id=28758162</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://diglog.io/tags/postgres/>Postgres</a></li><li><a href=https://diglog.io/tags/operator/>Operator</a></li></ul><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Postgres Operator on twitter" href="https://twitter.com/intent/tweet/?text=Postgres%20Operator&url=https%3a%2f%2fdiglog.io%2fposts%2fpostgres-operator%2f&hashtags=Postgres%2cOperator"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Postgres Operator on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fdiglog.io%2fposts%2fpostgres-operator%2f&title=Postgres%20Operator&summary=Postgres%20Operator&source=https%3a%2f%2fdiglog.io%2fposts%2fpostgres-operator%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Postgres Operator on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fdiglog.io%2fposts%2fpostgres-operator%2f&title=Postgres%20Operator"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Postgres Operator on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fdiglog.io%2fposts%2fpostgres-operator%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Postgres Operator on whatsapp" href="https://api.whatsapp.com/send?text=Postgres%20Operator%20-%20https%3a%2f%2fdiglog.io%2fposts%2fpostgres-operator%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Postgres Operator on telegram" href="https://telegram.me/share/url?text=Postgres%20Operator&url=https%3a%2f%2fdiglog.io%2fposts%2fpostgres-operator%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://diglog.io>Diglog</a></span>
<span>&#183;</span>
<span>Powered by <a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a></span>
<span>&#183;</span>
<span>Theme <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)"><button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></button></a>
<script>window.onload=function(){localStorage.getItem("menu-scroll-position")&&(document.getElementById("menu").scrollLeft=localStorage.getItem("menu-scroll-position"))};function menu_on_scroll(){localStorage.setItem("menu-scroll-position",document.getElementById("menu").scrollLeft)}document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(t=>{const n=t.parentNode.parentNode,e=document.createElement("button");e.classList.add("copy-code"),e.innerText="copy";function s(){e.innerText="copied!",setTimeout(()=>{e.innerText="copy"},2e3)}e.addEventListener("click",o=>{if("clipboard"in navigator){navigator.clipboard.writeText(t.textContent),s();return}const e=document.createRange();e.selectNodeContents(t);const n=window.getSelection();n.removeAllRanges(),n.addRange(e);try{document.execCommand("copy"),s()}catch(e){}n.removeRange(e)}),n.classList.contains("highlight")?n.appendChild(e):n.parentNode.firstChild==n||(t.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?t.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(e):t.parentNode.appendChild(e))})</script></body></html>